<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canadian Tax Quest Adventure - Mario Style Learning</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P:wght@400&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Press Start 2P', cursive;
            background: linear-gradient(135deg, #87CEEB 0%, #98FB98 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .clouds {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        .cloud {
            position: absolute;
            background: white;
            border-radius: 50px;
            opacity: 0.8;
            animation: float 20s infinite linear;
        }
        
        .cloud:before {
            content: '';
            position: absolute;
            background: white;
            border-radius: 50px;
        }
        
        .cloud1 {
            width: 80px;
            height: 40px;
            top: 20%;
            animation-duration: 25s;
        }
        
        .cloud1:before {
            width: 50px;
            height: 50px;
            top: -25px;
            left: 10px;
        }
        
        .cloud2 {
            width: 60px;
            height: 30px;
            top: 40%;
            animation-duration: 30s;
            animation-delay: -10s;
        }
        
        .cloud2:before {
            width: 40px;
            height: 40px;
            top: -20px;
            left: 15px;
        }
        
        @keyframes float {
            0% { transform: translateX(-100px); }
            100% { transform: translateX(calc(100vw + 100px)); }
        }
        
        .container {
            position: relative;
            z-index: 2;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .screen {
            display: none;
            min-height: 100vh;
            padding: 20px;
        }
        
        .screen.active {
            display: block;
        }
        
        .welcome-screen {
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: radial-gradient(circle, #FFD700 0%, #FFA500 100%);
        }
        
        .title {
            font-size: clamp(24px, 5vw, 48px);
            color: #FF0000;
            text-shadow: 4px 4px 0px #000, -2px -2px 0px #FFF;
            margin-bottom: 30px;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        
        .mario-character {
            font-size: 80px;
            margin: 20px 0;
            animation: jump 3s infinite;
        }
        
        @keyframes jump {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        
        .input-group {
            margin: 30px 0;
        }
        
        .input-group input {
            font-family: 'Press Start 2P', cursive;
            font-size: 16px;
            padding: 15px 20px;
            border: 4px solid #000;
            border-radius: 10px;
            background: #FFF;
            color: #000;
            text-align: center;
            min-width: 300px;
        }
        
        .btn {
            font-family: 'Press Start 2P', cursive;
            font-size: clamp(12px, 2.5vw, 18px);
            padding: 15px 30px;
            border: 4px solid #000;
            border-radius: 15px;
            background: linear-gradient(45deg, #FF6B6B, #FF8E53);
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            text-shadow: 2px 2px 0px #000;
            margin: 10px;
            display: inline-block;
            text-decoration: none;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 0 #000;
        }
        
        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 0 #000;
        }
        
        .btn-start {
            background: linear-gradient(45deg, #4ECDC4, #44A08D);
            font-size: 20px;
            padding: 20px 40px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .home-screen {
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(135deg, #87CEEB 0%, #98FB98 50%, #FFD700 100%);
            min-height: 100vh;
        }
        
        .home-header {
            margin-bottom: 40px;
        }
        
        .home-title {
            font-size: clamp(28px, 6vw, 56px);
            color: #FF0000;
            text-shadow: 4px 4px 0px #000, -2px -2px 0px #FFF;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }
        
        .player-welcome {
            background: rgba(255, 255, 255, 0.95);
            border: 4px solid #000;
            border-radius: 20px;
            padding: 25px;
            margin: 0 auto;
            max-width: 600px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
        }
        
        .world-map {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 30px;
            margin: 40px 0;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .level-node {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            border: 4px solid #000;
            border-radius: 20px;
            padding: 30px 20px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .level-node:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }
        
        .level-node.completed {
            background: linear-gradient(45deg, #98FB98, #90EE90);
        }
        
        .level-icon {
            font-size: 50px;
            margin-bottom: 15px;
        }
        
        .level-node h3 {
            font-size: 16px;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .level-node p {
            font-size: 12px;
            text-align: center;
            margin-bottom: 15px;
        }
        
        .quest-badge {
            background: linear-gradient(45deg, #FF6B6B, #FF8E53);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 10px;
            text-shadow: 1px 1px 0px #000;
        }
        
        .main-quest .quest-badge {
            background: linear-gradient(45deg, #4ECDC4, #44A08D);
        }
        
        .calculator-node .quest-badge {
            background: linear-gradient(45deg, #9B59B6, #8E44AD);
        }
        
        .achievements-node .quest-badge {
            background: linear-gradient(45deg, #F39C12, #E67E22);
        }
        
        .achievements-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: rgba(255, 255, 255, 0.98);
            border-left: 4px solid #000;
            box-shadow: -5px 0 15px rgba(0,0,0,0.3);
            transition: right 0.3s ease-in-out;
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }
        
        .achievements-panel.open {
            right: 0;
        }
        
        .achievements-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid #000;
        }
        
        .close-achievements {
            background: linear-gradient(45deg, #FF6B6B, #FF8E53);
            border: 2px solid #000;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 20px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .history-section {
            margin-bottom: 30px;
        }
        
        .history-item {
            background: linear-gradient(45deg, #E8F5E8, #C8E6C9);
            border: 3px solid #4CAF50;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }
        
        .history-item.incomplete {
            background: linear-gradient(45deg, #FFF3E0, #FFE0B2);
            border-color: #FF9800;
        }
        
        .history-item.failed {
            background: linear-gradient(45deg, #FFEBEE, #FFCDD2);
            border-color: #F44336;
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .history-status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 8px;
            color: white;
            text-shadow: 1px 1px 0px #000;
        }
        
        .status-completed {
            background: linear-gradient(45deg, #4CAF50, #45A049);
        }
        
        .status-incomplete {
            background: linear-gradient(45deg, #FF9800, #F57C00);
        }
        
        .status-failed {
            background: linear-gradient(45deg, #F44336, #D32F2F);
        }
        
        .history-details {
            font-size: 10px;
            line-height: 1.4;
        }
        
        .achievement-item {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            border: 3px solid #000;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .achievement-icon {
            font-size: 30px;
            margin-bottom: 10px;
        }
        
        .no-history {
            text-align: center;
            padding: 40px 20px;
            color: #666;
            font-size: 12px;
        }
        
        .quest-screen {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .quest-header {
            background: rgba(255, 255, 255, 0.95);
            border: 4px solid #000;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .score-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #000;
            color: #FFD700;
            padding: 15px 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .quest-content {
            background: rgba(255, 255, 255, 0.95);
            border: 4px solid #000;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
        }
        
        .question {
            font-size: clamp(14px, 2vw, 18px);
            line-height: 1.6;
            margin-bottom: 25px;
            color: #333;
        }
        
        .options {
            display: grid;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .option {
            background: linear-gradient(45deg, #E3F2FD, #BBDEFB);
            border: 3px solid #2196F3;
            border-radius: 10px;
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            text-align: left;
        }
        
        .option:hover {
            background: linear-gradient(45deg, #BBDEFB, #90CAF9);
            transform: translateX(5px);
        }
        
        .option.selected {
            background: linear-gradient(45deg, #FFD54F, #FFCC02);
            border-color: #FF9800;
        }
        
        .option.correct {
            background: linear-gradient(45deg, #C8E6C9, #A5D6A7);
            border-color: #4CAF50;
        }
        
        .option.incorrect {
            background: linear-gradient(45deg, #FFCDD2, #EF9A9A);
            border-color: #F44336;
        }
        
        .quest-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
        }
        
        .achievement-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: linear-gradient(45deg, #FFD700, #FFA500);
            border: 4px solid #000;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            z-index: 1000;
            transition: all 0.5s;
        }
        
        .achievement-popup.show {
            transform: translate(-50%, -50%) scale(1);
        }
        
        .confetti {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 999;
        }
        
        .confetti-piece {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #FFD700;
            animation: confetti-fall 3s linear forwards;
        }
        
        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
        
        .completion-screen {
            text-align: center;
            padding: 40px 20px;
            background: radial-gradient(circle, #FF6B6B 0%, #FF8E53 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .score-card {
            background: rgba(255, 255, 255, 0.95);
            border: 4px solid #000;
            border-radius: 20px;
            padding: 30px;
            margin: 20px auto;
            max-width: 600px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .score-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .score-item {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            border: 3px solid #000;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
        }
        
        .score-item h4 {
            font-size: 12px;
            margin-bottom: 10px;
        }
        
        .score-item .value {
            font-size: 18px;
            color: #000;
        }
        
        .share-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        .btn-share {
            background: linear-gradient(45deg, #4ECDC4, #44A08D);
            font-size: 14px;
            padding: 12px 25px;
        }
        
        .btn-screenshot {
            background: linear-gradient(45deg, #9B59B6, #8E44AD);
            font-size: 14px;
            padding: 12px 25px;
        }
        
        .history-summary {
            background: rgba(255, 255, 255, 0.9);
            border: 3px solid #000;
            border-radius: 15px;
            padding: 20px;
            margin: 20px auto;
            max-width: 800px;
            text-align: left;
        }
        
        .history-summary h3 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 16px;
        }
        
        .history-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .history-card {
            background: linear-gradient(45deg, #E8F5E8, #C8E6C9);
            border: 2px solid #4CAF50;
            border-radius: 10px;
            padding: 15px;
            font-size: 10px;
        }
        
        .history-card.incomplete {
            background: linear-gradient(45deg, #FFF3E0, #FFE0B2);
            border-color: #FF9800;
        }
        
        .screenshot-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.9), rgba(255, 142, 83, 0.9));
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
        }
        
        .screenshot-content {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border: 6px solid #000;
            border-radius: 25px;
            padding: 40px;
            text-align: center;
            max-width: 700px;
            margin: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            0% { transform: scale(0.8) translateY(-50px); opacity: 0; }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }
        
        .screenshot-content h3 {
            font-size: 24px;
            color: #000;
            text-shadow: 2px 2px 0px #FFF;
            margin-bottom: 20px;
        }
        
        .screenshot-preview {
            border: 5px solid #000;
            border-radius: 20px;
            margin: 25px 0;
            max-width: 100%;
            height: auto;
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
            background: white;
        }
        
        .screenshot-info {
            background: rgba(255, 255, 255, 0.9);
            border: 3px solid #000;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            font-size: 14px;
            color: #333;
        }
        
        .download-section {
            background: rgba(255, 255, 255, 0.8);
            border: 3px solid #000;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .btn-download {
            background: linear-gradient(45deg, #4CAF50, #45A049);
            font-size: 18px;
            padding: 15px 30px;
            margin: 10px;
            animation: pulse 2s infinite;
        }
        
        .btn-close-screenshot {
            background: linear-gradient(45deg, #FF6B6B, #FF8E53);
            font-size: 16px;
            padding: 12px 25px;
            margin: 10px;
        }
        
        .trophy {
            font-size: 120px;
            margin: 20px 0;
            animation: rotate 4s infinite linear;
        }
        
        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .fireworks {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        .firework {
            position: absolute;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            animation: firework 2s ease-out forwards;
        }
        
        @keyframes firework {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(20);
                opacity: 0;
            }
        }
        
        .pizza-calculator {
            background: rgba(255, 255, 255, 0.95);
            border: 4px solid #000;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            display: none;
        }
        
        .pizza-calculator.show {
            display: block;
            animation: slideDown 0.5s ease-out;
        }
        
        @keyframes slideDown {
            0% { transform: translateY(-20px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        
        .salary-input {
            font-family: 'Press Start 2P', cursive;
            font-size: 14px;
            padding: 10px;
            border: 3px solid #000;
            border-radius: 8px;
            margin: 10px;
            width: 200px;
        }
        
        .tax-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .tax-item {
            background: linear-gradient(45deg, #E8F5E8, #C8E6C9);
            border: 2px solid #4CAF50;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }
        
        .coin-animation {
            display: inline-block;
            animation: coinSpin 1s ease-in-out;
        }
        
        @keyframes coinSpin {
            0% { transform: rotateY(0deg) scale(1); }
            50% { transform: rotateY(180deg) scale(1.2); }
            100% { transform: rotateY(360deg) scale(1); }
        }
        
        .calculator-screen {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 40px 20px;
        }
        
        .calculator-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .calculator-content {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .salary-input-section {
            background: rgba(255, 255, 255, 0.95);
            border: 4px solid #000;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .main-salary-input {
            font-family: 'Press Start 2P', cursive;
            font-size: 18px;
            padding: 15px 25px;
            border: 4px solid #000;
            border-radius: 10px;
            margin: 20px;
            width: 300px;
            text-align: center;
        }
        
        .btn-calculate {
            background: linear-gradient(45deg, #4ECDC4, #44A08D);
            font-size: 16px;
            padding: 18px 35px;
        }
        
        .tax-results {
            background: rgba(255, 255, 255, 0.95);
            border: 4px solid #000;
            border-radius: 20px;
            padding: 30px;
            display: none;
        }
        
        .tax-results.show {
            display: block;
            animation: slideUp 0.5s ease-out;
        }
        
        @keyframes slideUp {
            0% { transform: translateY(30px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            align-items: start;
        }
        
        .pie-chart-container {
            text-align: center;
        }
        
        .pie-chart-container canvas {
            border: 3px solid #000;
            border-radius: 15px;
            background: white;
            max-width: 100%;
            height: auto;
        }
        
        .breakdown-details {
            text-align: left;
        }
        
        .main-tax-breakdown {
            display: grid;
            gap: 15px;
        }
        
        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            border: 2px solid #000;
            border-radius: 10px;
            padding: 15px 20px;
            font-size: 14px;
        }
        
        .breakdown-item.net-pay {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            font-weight: bold;
        }
        
        .breakdown-label {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .breakdown-amount {
            font-weight: bold;
        }
        
        .breakdown-percentage {
            font-size: 12px;
            color: #666;
            margin-left: 10px;
        }
        
        .calculator-navigation {
            text-align: center;
            margin-top: 30px;
        }
        
        .calculator-header-quest {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .btn-small {
            font-size: 10px;
            padding: 8px 15px;
            background: linear-gradient(45deg, #FF6B6B, #FF8E53);
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .quest-content {
                padding: 20px;
            }
            
            .options {
                gap: 10px;
            }
            
            .option {
                padding: 12px 15px;
                font-size: 12px;
            }
            
            .world-map {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .level-node {
                padding: 20px;
                min-height: 150px;
            }
            
            .level-icon {
                font-size: 40px;
            }
            
            .achievements-panel {
                width: 100%;
                right: -100%;
            }
            
            .results-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Animated Background -->
    <div class="clouds">
        <div class="cloud cloud1"></div>
        <div class="cloud cloud2"></div>
    </div>

    <!-- Welcome Screen -->
    <div id="welcomeScreen" class="screen active welcome-screen">
        <div class="container">
            <h1 class="title">🍄 CANADIAN TAX QUEST ADVENTURE 🍄</h1>
            <div class="mario-character">🍄</div>
            <p style="font-size: 16px; margin: 20px 0; color: #333;">Master Canadian Payroll Taxes in a Fun Mario World!</p>
            
            <div class="input-group">
                <input type="text" id="playerName" placeholder="Enter Your Name" maxlength="20">
            </div>
            
            <button class="btn btn-start" onclick="startGame()">
                🎮 PRESS START TO BEGIN 🎮
            </button>
        </div>
    </div>

    <!-- Home Screen -->
    <div id="homeScreen" class="screen home-screen">
        <div class="container">
            <div class="home-header">
                <h1 class="home-title">🍄 CANADIAN TAX QUEST WORLD 🍄</h1>
                <div class="player-welcome">
                    <h2>🌟 Welcome, <span id="playerNameDisplay"></span>! 🌟</h2>
                    <p>Choose your adventure in the world of Canadian payroll taxes!</p>
                </div>
            </div>
            
            <div class="world-map">
                <div class="level-node main-quest" onclick="startQuest()">
                    <div class="level-icon">🏰</div>
                    <h3>Begin Canadian Tax Quest</h3>
                    <p>Master 10 Canadian Tax Challenges!</p>
                    <div class="quest-badge">START QUEST</div>
                </div>
                <div class="level-node calculator-node" onclick="showCalculator()">
                    <div class="level-icon">🍕</div>
                    <h3>Canadian Payroll Calculator</h3>
                    <p>Interactive Canadian Tax Breakdown</p>
                    <div class="quest-badge">CALCULATE</div>
                </div>
                <div class="level-node achievements-node" onclick="toggleAchievements()">
                    <div class="level-icon">🏆</div>
                    <h3>View Achievements</h3>
                    <p>Track Your Progress</p>
                    <div class="quest-badge">VIEW HISTORY</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Achievements Panel -->
    <div id="achievementsPanel" class="achievements-panel">
        <div class="achievements-header">
            <h3>🏆 Your Journey</h3>
            <div class="close-achievements" onclick="toggleAchievements()">✕</div>
        </div>
        
        <div class="history-section">
            <h4>📊 Quest History</h4>
            <div id="questHistory">
                <div class="no-history">
                    <div style="font-size: 40px; margin-bottom: 15px;">🎮</div>
                    <p>No quest attempts yet!</p>
                    <p>Start your first quest to see your progress here.</p>
                </div>
            </div>
        </div>
        
        <div class="history-section">
            <h4>🏅 Achievements Unlocked</h4>
            <div id="achievementsList">
                <div class="no-history">
                    <div style="font-size: 40px; margin-bottom: 15px;">🏆</div>
                    <p>No achievements yet!</p>
                    <p>Complete quests to unlock achievements.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Quest Screen -->
    <div id="questScreen" class="screen quest-screen">
        <div class="container">
            <div class="score-bar">
                <div>🪙 Score: <span id="currentScore">0</span>/100</div>
                <div>🎯 Quest: <span id="currentQuest">1</span>/10</div>
                <div>👤 <span id="questPlayerName"></span></div>
            </div>
            
            <div class="quest-header">
                <h2 id="questTitle">Level 1: Tax Adventure Begins</h2>
            </div>
            
            <div class="quest-content">
                <div class="question" id="questionText"></div>
                <div class="options" id="optionsContainer"></div>
                
                <!-- Pizza Calculator -->
                <div id="pizzaCalculator" class="pizza-calculator">
                    <div class="calculator-header-quest">
                        <h3>🍕 Optional Tax Calculator 🍕</h3>
                        <button class="btn btn-small" onclick="toggleCalculator()">Hide Calculator</button>
                    </div>
                    <p>Enter your annual salary to see your tax breakdown like collecting coins!</p>
                    <input type="number" id="salaryInput" class="salary-input" placeholder="Annual Salary ($)">
                    <button class="btn" onclick="calculateTaxes()">Calculate Taxes 🪙</button>
                    <div id="taxBreakdown" class="tax-breakdown"></div>
                </div>
            </div>
            
            <div class="quest-navigation">
                <button class="btn" onclick="exitQuest()">🏠 Exit Quest</button>
                <button class="btn" id="nextBtn" onclick="nextQuest()" style="display: none;">Next Quest ➡️</button>
            </div>
        </div>
    </div>

    <!-- Calculator Screen -->
    <div id="calculatorScreen" class="screen calculator-screen">
        <div class="container">
            <div class="calculator-header">
                <h1 class="title">🍕 CANADIAN PAYROLL TAX CALCULATOR 🍕</h1>
                <p>See your Canadian tax breakdown with visual charts!</p>
            </div>
            
            <div class="calculator-content">
                <div class="salary-input-section">
                    <h3>Enter Your Annual Salary</h3>
                    <input type="number" id="mainSalaryInput" class="main-salary-input" placeholder="Annual Salary ($)">
                    <button class="btn btn-calculate" onclick="calculateMainTaxes()">Calculate My Taxes 🪙</button>
                </div>
                
                <div id="mainTaxResults" class="tax-results">
                    <div class="results-grid">
                        <div class="pie-chart-container">
                            <canvas id="taxPieChart" width="300" height="300"></canvas>
                            <h4>Tax Distribution</h4>
                        </div>
                        <div class="breakdown-details">
                            <h4>Detailed Breakdown</h4>
                            <div id="mainTaxBreakdown" class="main-tax-breakdown"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="calculator-navigation">
                <button class="btn" onclick="goHome()">🏠 Back to Home</button>
            </div>
        </div>
    </div>

    <!-- Completion Screen -->
    <div id="completionScreen" class="screen completion-screen">
        <div class="container">
            <h1 class="title">🎉 CANADIAN TAX QUEST COMPLETED! 🎉</h1>
            <div class="trophy">🏆</div>
            
            <div class="score-card" id="scoreCard">
                <h2>🌟 Congratulations, <span id="finalPlayerName"></span>! 🌟</h2>
                <p style="font-size: 14px; margin: 15px 0;">You've mastered Canadian Payroll Taxes like a true champion!</p>
                
                <div class="score-details">
                    <div class="score-item">
                        <h4>🎯 Final Score</h4>
                        <div class="value"><span id="finalScore"></span>/100</div>
                    </div>
                    <div class="score-item">
                        <h4>🏆 Quests Completed</h4>
                        <div class="value">10/10</div>
                    </div>
                    <div class="score-item">
                        <h4>⭐ Grade</h4>
                        <div class="value" id="finalGrade">A+</div>
                    </div>
                    <div class="score-item">
                        <h4>📅 Completed</h4>
                        <div class="value" id="completionDate" style="font-size: 12px;"></div>
                    </div>
                </div>
                
                <div class="share-buttons">
                    <button class="btn btn-screenshot" onclick="takeScreenshot()">📸 Take Screenshot</button>
                </div>
            </div>
            
            <div class="history-summary" id="historySummary">
                <h3>🏆 Your Quest Journey</h3>
                <div class="history-grid" id="completionHistory"></div>
            </div>
            
            <button class="btn btn-start" onclick="goHome()">🏠 Back to Home 🏠</button>
        </div>
        <div class="fireworks" id="fireworks"></div>
    </div>

    <!-- Screenshot Overlay -->
    <div id="screenshotOverlay" class="screenshot-overlay">
        <div class="screenshot-content">
            <h3>🏆 Your Tax Quest Champion Certificate! 🏆</h3>
            
            <div class="screenshot-info">
                <p><strong>🎉 Congratulations!</strong> You've created a beautiful certificate of your Tax Quest achievement!</p>
                <p>This certificate shows your final score, grade, and completion status.</p>
            </div>
            
            <canvas id="screenshotCanvas" class="screenshot-preview"></canvas>
            
            <div class="download-section">
                <h4>💾 Save Your Achievement</h4>
                <p>Click the download button below to save your certificate to your computer!</p>
                <button class="btn btn-download" onclick="downloadScreenshot()">
                    💾 Download Certificate
                </button>
            </div>
            
            <div class="share-buttons">
                <button class="btn btn-close-screenshot" onclick="closeScreenshot()">
                    ❌ Close
                </button>
            </div>
        </div>
    </div>

    <!-- Achievement Popup -->
    <div id="achievementPopup" class="achievement-popup">
        <h3 id="achievementTitle">🏆 Achievement Unlocked! 🏆</h3>
        <p id="achievementText"></p>
        <button class="btn" onclick="closeAchievement()">Awesome! ⭐</button>
    </div>

    <!-- Confetti Container -->
    <div id="confetti" class="confetti"></div>

    <script>
        // Game State
        let gameState = {
            playerName: '',
            currentQuest: 0,
            score: 0,
            completedQuests: [],
            achievements: [],
            questHistory: []
        };

        // Quest Data
        const quests = [
            {
                title: "Level 1: CPP Employee Contribution Rate",
                question: "🍁 What is the 2024 employee contribution rate for the Canada Pension Plan (CPP)? This is a key rate for Canadian payroll calculations!",
                options: [
                    "4.95%",
                    "5.95%",
                    "6.40%",
                    "7.00%"
                ],
                correct: 1,
                explanation: "🎯 Excellent! The 2024 CPP employee contribution rate is 5.95% - a crucial rate for Canadian payroll calculations!"
            },
            {
                title: "Level 2: CPP Basic Exemption",
                question: "🍁 How much is the basic exemption under CPP in 2024? This amount is not subject to CPP contributions!",
                options: [
                    "$0",
                    "$2,000",
                    "$3,500",
                    "$5,000"
                ],
                correct: 2,
                explanation: "🍰 Correct! The 2024 CPP basic exemption is $3,500 - earnings below this amount are not subject to CPP contributions!"
            },
            {
                title: "Level 3: EI Maximum Insurable Earnings",
                question: "🍁 What is the maximum insurable earnings for Employment Insurance (EI) in 2024? This cap is important for payroll calculations!",
                options: [
                    "$55,000",
                    "$63,200",
                    "$68,500",
                    "$70,000"
                ],
                correct: 1,
                explanation: "⚠️ Correct! The 2024 EI maximum insurable earnings is $63,200. Earnings above this amount are not subject to EI premiums!"
            },
            {
                title: "Level 4: Employer EI Contribution",
                question: "🍁 Employers contribute how much for EI compared to employees? This multiplier affects total payroll costs!",
                options: [
                    "The same as employees",
                    "Half of employee contribution",
                    "1.4 times employee contribution",
                    "Double employee contribution"
                ],
                correct: 2,
                explanation: "💍 Perfect! Employers contribute 1.4 times the employee EI contribution - this is the standard multiplier in Canada!"
            },
            {
                title: "Level 5: Federal Tax Credit",
                question: "🍁 Which of the following is a federal tax credit in 2024? This reduces the amount of tax owed!",
                options: [
                    "Canada Employment Credit",
                    "Employer Health Tax",
                    "QPP Contribution",
                    "Relevé 1 Slip"
                ],
                correct: 0,
                explanation: "🚀 Awesome! The Canada Employment Credit is a federal tax credit that reduces the amount of federal income tax owed!"
            },
            {
                title: "Level 6: Quebec Tax Slip",
                question: "🍁 In Quebec, which slip is issued in addition to the T4 at year-end? Quebec has unique reporting requirements!",
                options: [
                    "RL-1 Slip",
                    "T5 Slip",
                    "T2202 Slip",
                    "NR4 Slip"
                ],
                correct: 0,
                explanation: "🏆 Amazing! Quebec issues the RL-1 slip in addition to the T4 - this is unique to Quebec's tax system!"
            },
            {
                title: "Level 7: T4 Slip Deadline",
                question: "🍁 What is the deadline for employers to issue T4 slips to employees? Meeting deadlines is crucial for compliance!",
                options: [
                    "January 31",
                    "February 28",
                    "March 31",
                    "April 30"
                ],
                correct: 1,
                explanation: "🤝 Perfect! Employers must issue T4 slips to employees by February 28 - this is a critical compliance deadline!"
            },
            {
                title: "Level 8: Territorial Payroll Tax",
                question: "🍁 Which Canadian territories charge a 2% payroll tax on all employees, including non-residents? This is unique to these territories!",
                options: [
                    "Yukon and Alberta",
                    "Ontario and Manitoba",
                    "Northwest Territories and Nunavut",
                    "Quebec and British Columbia"
                ],
                correct: 2,
                explanation: "💸 Correct! Northwest Territories and Nunavut charge a 2% payroll tax on all employees, including non-residents!"
            },
            {
                title: "Level 9: BC Provincial Income Tax",
                question: "🍁 In British Columbia (2024), an employee earning $60,000 pays approximately how much in provincial income tax before credits?",
                options: [
                    "$1,500",
                    "$2,800",
                    "$4,000",
                    "$5,500"
                ],
                correct: 1,
                explanation: "📋 Smart! An employee earning $60,000 in BC pays approximately $2,800 in provincial income tax before credits!"
            },
            {
                title: "Level 10: Employer Obligations",
                question: "🍁 Which of the following is an employer obligation under Canadian payroll tax rules? This is fundamental to payroll compliance!",
                options: [
                    "Only deducting CPP",
                    "Paying employee income tax directly to employees",
                    "Deducting CPP, EI, and Income Tax and remitting them to CRA",
                    "Filing only federal slips, not provincial ones"
                ],
                correct: 2,
                explanation: "🧮 Excellent! Employers must deduct CPP, EI, and Income Tax from employee pay and remit these amounts to the CRA!"
            }
        ];

        // Sound Effects (using Web Audio API for compatibility)
        function playSound(type) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            let frequency;
            
            switch(type) {
                case 'coin':
                    frequency = 800;
                    break;
                case 'powerup':
                    frequency = 1200;
                    break;
                case 'jump':
                    frequency = 400;
                    break;
                default:
                    frequency = 600;
            }
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
            oscillator.type = 'square';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }

        // Game Functions
        function startGame() {
            const name = document.getElementById('playerName').value.trim();
            if (!name) {
                alert('Please enter your name to start your adventure! 🍄');
                return;
            }
            
            gameState.playerName = name;
            document.getElementById('playerNameDisplay').textContent = name;
            document.getElementById('questPlayerName').textContent = name;
            
            playSound('jump');
            showScreen('homeScreen');
        }

        function startQuest() {
            playSound('powerup');
            gameState.currentQuest = 0;
            gameState.score = 0;
            
            // Record quest start
            const questAttempt = {
                id: Date.now(),
                playerName: gameState.playerName,
                startTime: new Date().toLocaleString(),
                status: 'in-progress',
                currentLevel: 1,
                score: 0,
                questsCompleted: 0
            };
            
            gameState.questHistory.unshift(questAttempt);
            updateAchievementsPanel();
            
            showScreen('questScreen');
            loadQuest();
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        function loadQuest() {
            const quest = quests[gameState.currentQuest];
            document.getElementById('questTitle').textContent = quest.title;
            document.getElementById('questionText').textContent = quest.question;
            document.getElementById('currentQuest').textContent = gameState.currentQuest + 1;
            document.getElementById('currentScore').textContent = gameState.score;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            
            quest.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option';
                optionDiv.textContent = option;
                optionDiv.onclick = () => selectOption(index);
                optionsContainer.appendChild(optionDiv);
            });
            
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('pizzaCalculator').classList.remove('show');
            
            // Show pizza calculator for specific quests (optional)
            if (gameState.currentQuest === 7 || gameState.currentQuest === 9) {
                document.getElementById('pizzaCalculator').classList.add('show');
            }
        }

        function selectOption(selectedIndex) {
            const quest = quests[gameState.currentQuest];
            const options = document.querySelectorAll('.option');
            
            options.forEach((option, index) => {
                option.onclick = null;
                if (index === quest.correct) {
                    option.classList.add('correct');
                } else if (index === selectedIndex) {
                    option.classList.add('incorrect');
                } else {
                    option.style.opacity = '0.5';
                }
            });
            
            if (selectedIndex === quest.correct) {
                playSound('coin');
                gameState.score += Math.round(100 / quests.length);
                createConfetti();
                
                // Show explanation
                setTimeout(() => {
                    alert(quest.explanation);
                }, 500);
                
                // Check for achievements
                checkAchievements();
            } else {
                playSound('jump');
                setTimeout(() => {
                    alert("Not quite right! " + quest.explanation);
                }, 500);
            }
            
            document.getElementById('currentScore').textContent = gameState.score;
            document.getElementById('nextBtn').style.display = 'inline-block';
            
            // Update current quest attempt
            updateCurrentQuestAttempt();
        }

        function nextQuest() {
            gameState.currentQuest++;
            
            if (gameState.currentQuest >= quests.length) {
                completeGame();
            } else {
                playSound('jump');
                loadQuest();
            }
        }

        function completeGame() {
            document.getElementById('finalPlayerName').textContent = gameState.playerName;
            document.getElementById('finalScore').textContent = gameState.score;
            
            // Calculate grade
            const grade = gameState.score >= 90 ? 'A+' : 
                         gameState.score >= 80 ? 'A' : 
                         gameState.score >= 70 ? 'B+' : 
                         gameState.score >= 60 ? 'B' : 'C';
            document.getElementById('finalGrade').textContent = grade;
            
            // Set completion date
            document.getElementById('completionDate').textContent = new Date().toLocaleDateString();
            
            // Update quest history with completion
            if (gameState.questHistory.length > 0) {
                gameState.questHistory[0].status = 'completed';
                gameState.questHistory[0].endTime = new Date().toLocaleString();
                gameState.questHistory[0].finalScore = gameState.score;
                gameState.questHistory[0].questsCompleted = 10;
                gameState.questHistory[0].grade = grade;
            }
            
            // Show completion history
            updateCompletionHistory();
            
            playSound('powerup');
            showScreen('completionScreen');
            createFireworks();
            updateAchievementsPanel();
            
            // Final achievement
            showAchievement("Tax Champion 👑", "You've completed all 15 quests and mastered payroll taxes!");
        }
        
        function updateCompletionHistory() {
            const historyContainer = document.getElementById('completionHistory');
            
            if (gameState.questHistory.length === 0) {
                historyContainer.innerHTML = '<p style="text-align: center; color: #666;">No previous attempts found.</p>';
                return;
            }
            
            historyContainer.innerHTML = gameState.questHistory.map((attempt, index) => {
                const statusClass = attempt.status === 'completed' ? 'completed' : 
                                   attempt.status === 'exited' ? 'incomplete' : 'incomplete';
                const statusIcon = attempt.status === 'completed' ? '🏆' : 
                                  attempt.status === 'exited' ? '🚪' : '⏸️';
                
                return `
                    <div class="history-card ${statusClass}">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <strong>Attempt #${gameState.questHistory.length - index}</strong>
                            <span>${statusIcon}</span>
                        </div>
                        <p><strong>Date:</strong> ${attempt.startTime.split(',')[0]}</p>
                        <p><strong>Score:</strong> ${attempt.finalScore || attempt.score}/100</p>
                        <p><strong>Level:</strong> ${attempt.questsCompleted}/15</p>
                        <p><strong>Status:</strong> ${attempt.status.charAt(0).toUpperCase() + attempt.status.slice(1)}</p>
                        ${attempt.grade ? `<p><strong>Grade:</strong> ${attempt.grade}</p>` : ''}
                        ${attempt.exitReason ? `<p><strong>Exit:</strong> ${attempt.exitReason}</p>` : ''}
                    </div>
                `;
            }).join('');
        }
        
        function takeScreenshot() {
            const canvas = document.getElementById('screenshotCanvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size for certificate
            canvas.width = 800;
            canvas.height = 1000;
            
            // Create beautiful gradient background
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, '#FFD700');
            gradient.addColorStop(0.3, '#FFA500');
            gradient.addColorStop(0.7, '#FF8C00');
            gradient.addColorStop(1, '#FF6B6B');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Add decorative border
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 8;
            ctx.strokeRect(20, 20, canvas.width - 40, canvas.height - 40);
            
            // Inner decorative border
            ctx.strokeStyle = '#FFF';
            ctx.lineWidth = 4;
            ctx.strokeRect(35, 35, canvas.width - 70, canvas.height - 70);
            
            // Certificate title
            ctx.fillStyle = '#000';
            ctx.font = 'bold 36px Arial';
            ctx.textAlign = 'center';
            ctx.strokeStyle = '#FFF';
            ctx.lineWidth = 2;
            ctx.strokeText('🏆 CERTIFICATE OF ACHIEVEMENT 🏆', canvas.width/2, 120);
            ctx.fillText('🏆 CERTIFICATE OF ACHIEVEMENT 🏆', canvas.width/2, 120);
            
            // Main title
            ctx.font = 'bold 42px Arial';
            ctx.fillStyle = '#8B0000';
            ctx.strokeStyle = '#FFD700';
            ctx.lineWidth = 3;
            ctx.strokeText('CANADIAN TAX QUEST CHAMPION', canvas.width/2, 180);
            ctx.fillText('CANADIAN TAX QUEST CHAMPION', canvas.width/2, 180);
            
            // Trophy emoji
            ctx.font = '100px Arial';
            ctx.fillText('🏆', canvas.width/2, 280);
            
            // Certificate body background
            ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 4;
            const certX = 80, certY = 320, certW = canvas.width - 160, certH = 500;
            ctx.fillRect(certX, certY, certW, certH);
            ctx.strokeRect(certX, certY, certW, certH);
            
            // "This certifies that" text
            ctx.fillStyle = '#000';
            ctx.font = 'italic 24px Arial';
            ctx.fillText('This certifies that', canvas.width/2, 370);
            
            // Player name with decorative underline
            ctx.font = 'bold 36px Arial';
            ctx.fillStyle = '#8B0000';
            ctx.fillText(gameState.playerName, canvas.width/2, 420);
            
            // Underline for name
            const nameWidth = ctx.measureText(gameState.playerName).width;
            ctx.strokeStyle = '#8B0000';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(canvas.width/2 - nameWidth/2, 435);
            ctx.lineTo(canvas.width/2 + nameWidth/2, 435);
            ctx.stroke();
            
            // Achievement text
            ctx.fillStyle = '#000';
            ctx.font = '22px Arial';
            ctx.fillText('has successfully completed', canvas.width/2, 470);
            
            ctx.font = 'bold 28px Arial';
            ctx.fillStyle = '#8B0000';
            ctx.fillText('CANADIAN TAX QUEST ADVENTURE', canvas.width/2, 510);
            
            ctx.fillStyle = '#000';
            ctx.font = '20px Arial';
            ctx.fillText('and mastered Canadian Payroll Tax concepts', canvas.width/2, 540);
            
            // Score details in a box
            ctx.fillStyle = 'rgba(255, 215, 0, 0.3)';
            ctx.fillRect(certX + 40, 570, certW - 80, 120);
            ctx.strokeStyle = '#8B0000';
            ctx.lineWidth = 2;
            ctx.strokeRect(certX + 40, 570, certW - 80, 120);
            
            const grade = gameState.score >= 90 ? 'A+' : 
                         gameState.score >= 80 ? 'A' : 
                         gameState.score >= 70 ? 'B+' : 
                         gameState.score >= 60 ? 'B' : 'C';
            
            ctx.fillStyle = '#000';
            ctx.font = 'bold 24px Arial';
            ctx.fillText(`Final Score: ${gameState.score}/100`, canvas.width/2, 610);
            ctx.fillText(`Grade Achieved: ${grade}`, canvas.width/2, 640);
            ctx.fillText('Quests Completed: 10/10', canvas.width/2, 670);
            
            // Achievement badges
            ctx.font = '50px Arial';
            ctx.fillText('⭐ 🎯 💰 📋 🏆', canvas.width/2, 750);
            
            // Date and signature line
            ctx.fillStyle = '#000';
            ctx.font = '18px Arial';
            const completionDate = new Date().toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            ctx.fillText(`Completed on: ${completionDate}`, canvas.width/2, 790);
            
            // Signature line
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(canvas.width/2 - 100, 810);
            ctx.lineTo(canvas.width/2 + 100, 810);
            ctx.stroke();
            
            ctx.font = '16px Arial';
            ctx.fillText('Tax Quest Academy', canvas.width/2, 830);
            
            // Footer
            ctx.font = 'bold 20px Arial';
            ctx.fillStyle = '#8B0000';
            ctx.fillText('🍄 Canadian Tax Quest Adventure - Mario Style Learning 🍄', canvas.width/2, 920);
            
            // Decorative corners
            ctx.font = '40px Arial';
            ctx.fillText('🍄', 70, 70);
            ctx.fillText('🪙', canvas.width - 70, 70);
            ctx.fillText('⭐', 70, canvas.height - 30);
            ctx.fillText('🏆', canvas.width - 70, canvas.height - 30);
            
            // Show screenshot overlay
            document.getElementById('screenshotOverlay').style.display = 'flex';
        }
        
        function downloadScreenshot() {
            const canvas = document.getElementById('screenshotCanvas');
            
            // Create download link
            const link = document.createElement('a');
            const playerNameClean = gameState.playerName.replace(/[^a-zA-Z0-9]/g, '_');
            const dateString = new Date().toISOString().split('T')[0];
            const grade = gameState.score >= 90 ? 'A+' : 
                         gameState.score >= 80 ? 'A' : 
                         gameState.score >= 70 ? 'B+' : 
                         gameState.score >= 60 ? 'B' : 'C';
            
            link.download = `Tax_Quest_Certificate_${playerNameClean}_Grade_${grade}_Score_${gameState.score}_${dateString}.png`;
            link.href = canvas.toDataURL('image/png', 1.0);
            
            // Trigger download
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Show success message
            setTimeout(() => {
                alert(`🎉 Certificate Downloaded Successfully!\n\n📁 File saved as:\n${link.download}\n\n🏆 Your Tax Quest achievement certificate is now saved to your computer!`);
            }, 500);
        }
        
        function closeScreenshot() {
            document.getElementById('screenshotOverlay').style.display = 'none';
        }
        
        function shareScore() {
            const shareText = `🎉 I just completed Canadian Tax Quest Adventure! 🏆\n\nFinal Score: ${gameState.score}/100\nGrade: ${document.getElementById('finalGrade').textContent}\nQuests Completed: 10/10\n\nI've mastered Canadian Payroll Taxes like a champion! 💰📋\n\n#CanadianTaxQuest #LearningIsFun #CanadianPayrollTaxes`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Canadian Tax Quest Adventure - Champion!',
                    text: shareText,
                    url: window.location.href
                }).catch(console.error);
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(shareText).then(() => {
                    alert('🎉 Score copied to clipboard! Share it with your friends!');
                }).catch(() => {
                    // Final fallback: show text in alert
                    alert('Share your achievement:\n\n' + shareText);
                });
            }
        }
        
        function exitQuest() {
            // Create custom confirmation dialog
            const confirmExit = confirm("⚠️ EXIT QUEST CONFIRMATION ⚠️\n\n🚨 WARNING: Your progress will NOT be saved!\n\n📊 Current Status:\n• Level: " + (gameState.currentQuest + 1) + "/10\n• Score: " + gameState.score + "/100\n\n🔄 If you exit now:\n• You'll return to the home screen\n• You'll need to restart from Quest 1\n• This attempt will be recorded as 'EXITED' in your history\n\n❓ Do you really want to exit and lose your progress?");
            
            if (confirmExit) {
                // Update quest history with exit
                if (gameState.questHistory.length > 0) {
                    gameState.questHistory[0].status = 'exited';
                    gameState.questHistory[0].endTime = new Date().toLocaleString();
                    gameState.questHistory[0].finalScore = gameState.score;
                    gameState.questHistory[0].questsCompleted = gameState.currentQuest;
                    gameState.questHistory[0].currentLevel = gameState.currentQuest + 1;
                    gameState.questHistory[0].exitReason = 'Player voluntarily exited quest';
                }
                
                // Reset game state
                gameState.currentQuest = 0;
                gameState.score = 0;
                
                updateAchievementsPanel();
                playSound('jump');
                showScreen('homeScreen');
                
                // Show exit confirmation message
                setTimeout(() => {
                    alert("🚪 Quest Exited!\n\nYour attempt has been recorded in your history.\nYou can start a new quest anytime! 🎮");
                }, 500);
            }
        }
        
        function updateCurrentQuestAttempt() {
            if (gameState.questHistory.length > 0) {
                gameState.questHistory[0].currentLevel = gameState.currentQuest + 1;
                gameState.questHistory[0].score = gameState.score;
                gameState.questHistory[0].questsCompleted = gameState.currentQuest;
                updateAchievementsPanel();
            }
        }
        
        function toggleAchievements() {
            const panel = document.getElementById('achievementsPanel');
            panel.classList.toggle('open');
            updateAchievementsPanel();
        }
        
        function updateAchievementsPanel() {
            const historyContainer = document.getElementById('questHistory');
            const achievementsContainer = document.getElementById('achievementsList');
            
            // Update quest history
            if (gameState.questHistory.length === 0) {
                historyContainer.innerHTML = `
                    <div class="no-history">
                        <div style="font-size: 40px; margin-bottom: 15px;">🎮</div>
                        <p>No quest attempts yet!</p>
                        <p>Start your first quest to see your progress here.</p>
                    </div>
                `;
            } else {
                historyContainer.innerHTML = gameState.questHistory.map((attempt, index) => {
                    const statusClass = attempt.status === 'completed' ? 'completed' : 
                                       attempt.status === 'exited' ? 'failed' :
                                       attempt.status === 'incomplete' ? 'incomplete' : 'failed';
                    const statusText = attempt.status === 'completed' ? 'COMPLETED' : 
                                      attempt.status === 'exited' ? 'EXITED' :
                                      attempt.status === 'incomplete' ? 'INCOMPLETE' : 'IN PROGRESS';
                    const statusIcon = attempt.status === 'completed' ? '🏆' : 
                                      attempt.status === 'exited' ? '🚪' :
                                      attempt.status === 'incomplete' ? '⏸️' : '🎮';
                    
                    return `
                        <div class="history-item ${statusClass}">
                            <div class="history-header">
                                <strong>Quest Attempt #${gameState.questHistory.length - index}</strong>
                                <div class="history-status status-${statusClass}">${statusText}</div>
                            </div>
                            <div class="history-details">
                                <p><strong>Player:</strong> ${attempt.playerName}</p>
                                <p><strong>Started:</strong> ${attempt.startTime}</p>
                                ${attempt.endTime ? `<p><strong>Ended:</strong> ${attempt.endTime}</p>` : ''}
                                <p><strong>Level Reached:</strong> ${attempt.currentLevel}/10</p>
                                <p><strong>Score:</strong> ${attempt.finalScore || attempt.score}/100</p>
                                <p><strong>Quests Completed:</strong> ${attempt.questsCompleted}/10</p>
                                <p><strong>Status:</strong> ${statusIcon} ${attempt.status.charAt(0).toUpperCase() + attempt.status.slice(1)}</p>
                                ${attempt.exitReason ? `<p><strong>Exit Reason:</strong> ${attempt.exitReason}</p>` : ''}
                                ${attempt.grade ? `<p><strong>Grade:</strong> ${attempt.grade}</p>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Update achievements
            if (gameState.achievements.length === 0) {
                achievementsContainer.innerHTML = `
                    <div class="no-history">
                        <div style="font-size: 40px; margin-bottom: 15px;">🏆</div>
                        <p>No achievements yet!</p>
                        <p>Complete quests to unlock achievements.</p>
                    </div>
                `;
            } else {
                achievementsContainer.innerHTML = gameState.achievements.map(achievement => `
                    <div class="achievement-item">
                        <div class="achievement-icon">${achievement.icon}</div>
                        <h4>${achievement.title}</h4>
                        <p>${achievement.description}</p>
                        <small>Unlocked: ${achievement.date}</small>
                    </div>
                `).join('');
            }
        }
        
        function goHome() {
            playSound('jump');
            showScreen('homeScreen');
        }

        function checkAchievements() {
            const questsCompleted = gameState.currentQuest + 1;
            
            if (questsCompleted === 5 && !gameState.achievements.find(a => a.id === 'tax-slayer')) {
                const achievement = {
                    id: 'tax-slayer',
                    title: 'CPP Master ⚔️',
                    description: 'Completed your first 5 Canadian tax quests!',
                    icon: '⚔️',
                    date: new Date().toLocaleString()
                };
                gameState.achievements.push(achievement);
                showAchievement(achievement.title, achievement.description);
            }
            
            if (gameState.score >= 80 && !gameState.achievements.find(a => a.id === 'high-scorer')) {
                const achievement = {
                    id: 'high-scorer',
                    title: 'High Scorer 🎯',
                    description: 'Achieved 80+ points!',
                    icon: '🎯',
                    date: new Date().toLocaleString()
                };
                gameState.achievements.push(achievement);
                showAchievement(achievement.title, achievement.description);
            }
            
            if (questsCompleted === 10 && !gameState.achievements.find(a => a.id === 'champion')) {
                const achievement = {
                    id: 'champion',
                    title: 'Canadian Tax Champion 👑',
                    description: 'Completed all 10 quests and mastered Canadian payroll taxes!',
                    icon: '👑',
                    date: new Date().toLocaleString()
                };
                gameState.achievements.push(achievement);
            }
        }

        function showAchievement(title, text) {
            document.getElementById('achievementTitle').textContent = title;
            document.getElementById('achievementText').textContent = text;
            document.getElementById('achievementPopup').classList.add('show');
            playSound('powerup');
        }

        function closeAchievement() {
            document.getElementById('achievementPopup').classList.remove('show');
        }

        function createConfetti() {
            const confettiContainer = document.getElementById('confetti');
            const colors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7'];
            
            for (let i = 0; i < 50; i++) {
                const confettiPiece = document.createElement('div');
                confettiPiece.className = 'confetti-piece';
                confettiPiece.style.left = Math.random() * 100 + '%';
                confettiPiece.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confettiPiece.style.animationDelay = Math.random() * 2 + 's';
                confettiContainer.appendChild(confettiPiece);
                
                setTimeout(() => {
                    confettiPiece.remove();
                }, 3000);
            }
        }

        function createFireworks() {
            const fireworksContainer = document.getElementById('fireworks');
            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD'];
            
            for (let i = 0; i < 20; i++) {
                setTimeout(() => {
                    const firework = document.createElement('div');
                    firework.className = 'firework';
                    firework.style.left = Math.random() * 100 + '%';
                    firework.style.top = Math.random() * 100 + '%';
                    firework.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    fireworksContainer.appendChild(firework);
                    
                    setTimeout(() => {
                        firework.remove();
                    }, 2000);
                }, i * 200);
            }
        }

        // Initialize game
        document.addEventListener('DOMContentLoaded', function() {
            // Add some initial floating elements
            createConfetti();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'976b73c462f94001',t:'MTc1NjQ2NDI2My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
